name: PRè‡ªåŠ¨æ£€æŸ¥

# æƒé™é…ç½® - éœ€è¦å†™æƒé™æ¥åˆ›å»ºè¯„è®º
permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    runs-on: ubuntu-latest
    steps:
      - name: æ˜¾ç¤ºPRä¿¡æ¯
        run: |
          echo "ğŸ” PRæ£€æŸ¥å¼€å§‹"
          echo "===================="
          echo "PRç¼–å·: ${{ github.event.pull_request.number }}"
          echo "ä½œè€…: ${{ github.event.pull_request.user.login }}"
          echo "æ ‡é¢˜: ${{ github.event.pull_request.title }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.pull_request.base.ref }}"
          echo "æºåˆ†æ”¯: ${{ github.event.pull_request.head.ref }}"
          echo "===================="

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–PRä¿¡æ¯
        id: pr-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "head_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check-files
        run: |
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          git fetch origin ${{ steps.pr-info.outputs.base_branch }}
          CHANGED_FILES=$(git diff --name-only origin/${{ steps.pr-info.outputs.base_branch }}...HEAD)
          echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
          echo "$CHANGED_FILES"
          
          # æ£€æŸ¥æ˜¯å¦åªæœ‰æ–‡æ¡£æ–‡ä»¶å˜æ›´
          NON_DOC_FILES=$(echo "$CHANGED_FILES" | grep -v -E '\.(md|txt|rst|doc|docx|pdf)$' | grep -v '^docs/' | grep -v '^README' | grep -v '^CHANGELOG' | grep -v '^LICENSE' || true)
          
          if [ -z "$NON_DOC_FILES" ]; then
            echo "only_docs=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°ä»…æœ‰æ–‡æ¡£æ–‡ä»¶å˜æ›´"
          else
            echo "only_docs=false" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°éæ–‡æ¡£æ–‡ä»¶å˜æ›´ï¼š"
            echo "$NON_DOC_FILES"
          fi

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        if: steps.check-files.outputs.only_docs == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        if: steps.check-files.outputs.only_docs == 'false'
        run: |
          npm install
          cd client && npm install
          cd ../server && npm install

      - name: TypeScriptç±»å‹æ£€æŸ¥
        if: steps.check-files.outputs.only_docs == 'false'
        id: type-check
        run: |
          echo "å¼€å§‹TypeScriptç±»å‹æ£€æŸ¥..."
          
          # æ£€æŸ¥serverç«¯
          echo "æ£€æŸ¥serverç«¯TypeScript..."
          cd server
          if npx tsc --noEmit; then
            echo "server_check=success" >> $GITHUB_OUTPUT
            echo "âœ… Serverç«¯TypeScriptæ£€æŸ¥é€šè¿‡"
          else
            echo "server_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ Serverç«¯TypeScriptæ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          cd ..
          
          # æ£€æŸ¥clientç«¯
          echo "æ£€æŸ¥clientç«¯TypeScript..."
          cd client
          if npx tsc --noEmit; then
            echo "client_check=success" >> $GITHUB_OUTPUT
            echo "âœ… Clientç«¯TypeScriptæ£€æŸ¥é€šè¿‡"
          else
            echo "client_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ Clientç«¯TypeScriptæ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          echo "type_check_result=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: å¤„ç†TypeScriptæ£€æŸ¥å¤±è´¥
        if: steps.check-files.outputs.only_docs == 'false' && steps.type-check.outputs.type_check_result != 'success'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const comment = `## âŒ TypeScriptç±»å‹æ£€æŸ¥å¤±è´¥

            æ‚¨çš„PRåŒ…å«TypeScriptç±»å‹é”™è¯¯ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤ã€‚

            ### æ£€æŸ¥ç»“æœï¼š
            - Serverç«¯æ£€æŸ¥ï¼š${{ steps.type-check.outputs.server_check == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
            - Clientç«¯æ£€æŸ¥ï¼š${{ steps.type-check.outputs.client_check == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}

            ### æœ¬åœ°æ£€æŸ¥å‘½ä»¤ï¼š
            \`\`\`bash
            # å®‰è£…ä¾èµ–
            npm run install:all

            # è¿è¡Œå®Œæ•´æ£€æŸ¥
            npm run check-types

            # æˆ–è€…åˆ†åˆ«æ£€æŸ¥
            cd server && npx tsc --noEmit
            cd client && npx tsc --noEmit
            \`\`\`

            ### å¸¸è§é—®é¢˜ï¼š
            - æ£€æŸ¥ç±»å‹å®šä¹‰æ˜¯å¦æ­£ç¡®
            - ç¡®ä¿æ‰€æœ‰å¯¼å…¥è·¯å¾„æ­£ç¡®
            - ç§»é™¤æœªä½¿ç”¨çš„å˜é‡å’Œå¯¼å…¥

            ä¿®å¤æ‰€æœ‰ç±»å‹é”™è¯¯åï¼Œè¯·é‡æ–°æ¨é€ä»£ç ã€‚`;

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('âœ… å·²åˆ›å»ºé”™è¯¯æç¤ºè¯„è®º');
            } catch (error) {
              console.log('âŒ åˆ›å»ºè¯„è®ºå¤±è´¥:', error.message);
              console.log('æ£€æŸ¥ç»“æœå·²åœ¨æ§åˆ¶å°è¾“å‡º');
            }

      - name: å¤„ç†çº¯æ–‡æ¡£å˜æ›´
        if: steps.check-files.outputs.only_docs == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const comment = `## ğŸ“ æ–‡æ¡£å˜æ›´æ£€æµ‹

            æ£€æµ‹åˆ°æ‚¨çš„PRä»…åŒ…å«æ–‡æ¡£æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€è¿›è¡Œä»£ç æ£€æŸ¥ã€‚

            ### å˜æ›´ç±»å‹ï¼š
            - ğŸ“„ æ–‡æ¡£æ–‡ä»¶æ›´æ–°
            - âœ… è·³è¿‡ä»£ç æ£€æŸ¥
            - â³ ç­‰å¾…äººå·¥å®¡æ ¸

            æ­¤PRæ­£åœ¨ç­‰å¾…é¡¹ç›®ç»´æŠ¤è€…çš„æœ€ç»ˆå®¡æ ¸ã€‚æ„Ÿè°¢æ‚¨å¯¹æ–‡æ¡£çš„è´¡çŒ®ï¼ ğŸ‰`;

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('âœ… å·²åˆ›å»ºæ–‡æ¡£å˜æ›´æç¤ºè¯„è®º');
            } catch (error) {
              console.log('âŒ åˆ›å»ºè¯„è®ºå¤±è´¥:', error.message);
              console.log('æ–‡æ¡£å˜æ›´æ£€æµ‹ç»“æœå·²åœ¨æ§åˆ¶å°è¾“å‡º');
            }

      - name: å¤„ç†æ£€æŸ¥æˆåŠŸ
        if: steps.check-files.outputs.only_docs == 'false' && steps.type-check.outputs.type_check_result == 'success'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const baseBranch = '${{ steps.pr-info.outputs.base_branch }}';

            let branchMessage = '';
            if (baseBranch === 'main') {
              branchMessage = '\nâš ï¸ **æ³¨æ„**: æ‚¨çš„PRç›®æ ‡æ˜¯mainåˆ†æ”¯ï¼Œå»ºè®®é¡¹ç›®ç»´æŠ¤è€…å°†å…¶åˆå¹¶åˆ°featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•ã€‚';
            } else if (baseBranch === 'feature') {
              branchMessage = '\nâœ… **ç›®æ ‡åˆ†æ”¯**: æ‚¨çš„PRæ­£ç¡®åœ°æŒ‡å‘äº†featureåˆ†æ”¯ã€‚';
            }

            const comment = `## âœ… è‡ªåŠ¨åŒ–æ£€æŸ¥é€šè¿‡

            æ‚¨çš„PRå·²é€šè¿‡æ‰€æœ‰è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼

            ### æ£€æŸ¥ç»“æœï¼š
            - TypeScriptç±»å‹æ£€æŸ¥ï¼šâœ… é€šè¿‡
            - Serverç«¯æ£€æŸ¥ï¼šâœ… é€šè¿‡
            - Clientç«¯æ£€æŸ¥ï¼šâœ… é€šè¿‡
            ${branchMessage}

            ### ä¸‹ä¸€æ­¥ï¼š
            é¡¹ç›®ç»´æŠ¤è€…å°†å®¡æ ¸æ‚¨çš„ä»£ç å¹¶å†³å®šåˆå¹¶ç­–ç•¥ï¼š
            - å¦‚æœç›®æ ‡æ˜¯mainåˆ†æ”¯ï¼Œå°†å…ˆåˆå¹¶åˆ°featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•
            - æµ‹è¯•é€šè¿‡åä¼šåˆå¹¶åˆ°ä¸»åˆ†æ”¯å¹¶åœ¨ä¸‹ä¸ªç‰ˆæœ¬å‘å¸ƒæ—¶åŠ å…¥

            æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ ğŸ‰

            ---
            *æ³¨ï¼šéœ€è¦ç»´æŠ¤è€…æ‰‹åŠ¨åˆå¹¶æ“ä½œã€‚*`;

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('âœ… æˆåŠŸåˆ›å»ºæˆåŠŸæç¤ºè¯„è®º');
            } catch (error) {
              console.log('âŒ åˆ›å»ºè¯„è®ºå¤±è´¥:', error.message);
              console.log('ğŸ‰ TypeScriptæ£€æŸ¥é€šè¿‡ï¼Œç»“æœå·²åœ¨æ§åˆ¶å°è¾“å‡º');
            }

      - name: è¾“å‡ºæœ€ç»ˆç»“æœæ‘˜è¦
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š PRæ£€æŸ¥ç»“æœæ‘˜è¦"
          echo "===================="
          echo "PRç¼–å·: ${{ github.event.pull_request.number }}"
          echo "ä½œè€…: ${{ github.event.pull_request.user.login }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ steps.pr-info.outputs.base_branch }}"
          echo "æºåˆ†æ”¯: ${{ steps.pr-info.outputs.head_branch }}"
          echo ""

          if [ "${{ steps.check-files.outputs.only_docs }}" = "true" ]; then
            echo "ğŸ“ å˜æ›´ç±»å‹: ä»…æ–‡æ¡£æ–‡ä»¶"
            echo "âœ… çŠ¶æ€: ç­‰å¾…äººå·¥å®¡æ ¸"
            echo ""
            echo "ğŸ’¡ ç»´æŠ¤è€…æ“ä½œå»ºè®®:"
            echo "- å¯ä»¥ç›´æ¥å®¡æ ¸å¹¶åˆå¹¶æ­¤PR"
            echo "- æ— éœ€ä»£ç æ£€æŸ¥"
          else
            echo "ğŸ” å˜æ›´ç±»å‹: åŒ…å«ä»£ç æ–‡ä»¶"
            echo "Serverç«¯æ£€æŸ¥: ${{ steps.type-check.outputs.server_check }}"
            echo "Clientç«¯æ£€æŸ¥: ${{ steps.type-check.outputs.client_check }}"
            echo "æ€»ä½“ç»“æœ: ${{ steps.type-check.outputs.type_check_result }}"
            echo ""

            if [ "${{ steps.type-check.outputs.type_check_result }}" = "success" ]; then
              echo "ğŸ‰ çŠ¶æ€: æ‰€æœ‰æ£€æŸ¥é€šè¿‡"
              echo ""
              echo "ğŸ’¡ ç»´æŠ¤è€…æ“ä½œå»ºè®®:"
              if [ "${{ steps.pr-info.outputs.base_branch }}" = "main" ]; then
                echo "- å»ºè®®å…ˆåˆå¹¶åˆ°featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•"
                echo "- æµ‹è¯•é€šè¿‡åå†åˆå¹¶åˆ°mainåˆ†æ”¯"
              else
                echo "- å¯ä»¥åˆå¹¶åˆ°${{ steps.pr-info.outputs.base_branch }}åˆ†æ”¯"
              fi
            else
              echo "âŒ çŠ¶æ€: æ£€æŸ¥å¤±è´¥"
              echo ""
              echo "ğŸ’¡ éœ€è¦ä¿®å¤:"
              if [ "${{ steps.type-check.outputs.server_check }}" = "failed" ]; then
                echo "- ä¿®å¤serverç«¯TypeScripté”™è¯¯"
              fi
              if [ "${{ steps.type-check.outputs.client_check }}" = "failed" ]; then
                echo "- ä¿®å¤clientç«¯TypeScripté”™è¯¯"
              fi
              echo ""
              echo "ğŸ”§ æœ¬åœ°æ£€æŸ¥å‘½ä»¤:"
              echo "npm run check-types"
            fi
          fi
          echo "===================="

      - name: è®¾ç½®æ£€æŸ¥çŠ¶æ€
        if: always()
        run: |
          # æ ¹æ®æ£€æŸ¥ç»“æœè®¾ç½®é€€å‡ºç 
          if [ "${{ steps.check-files.outputs.only_docs }}" = "true" ]; then
            echo "ğŸ“ æ–‡æ¡£å˜æ›´ï¼Œæ£€æŸ¥é€šè¿‡"
            exit 0
          elif [ "${{ steps.type-check.outputs.type_check_result }}" = "success" ]; then
            echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
            exit 0
          else
            echo "âŒ ä»£ç æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
