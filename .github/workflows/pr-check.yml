name: PR 自动审查与分流

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  pr-flow:
    name: PR 自动化流程
    runs-on: ubuntu-latest

    steps:
      - name: 初始评论 - 正在进行自动化审查
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: '👋 本 PR 已进入自动化审查流程，正在进行变更识别与类型检查，请稍候～'
            });

      - name: 检出 PR 提交代码
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: 识别是否仅修改文档
        id: flags
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const files = await github.paginate(github.rest.pulls.listFiles, { owner, repo, pull_number: number, per_page: 100 });
            const isDoc = (f) => {
              const n = f.filename.toLowerCase();
              return n.endsWith('.md') || n.endsWith('.mdx') || n.endsWith('.txt') || n.startsWith('docs/');
            };
            const docsOnly = files.length > 0 && files.every(isDoc);
            core.setOutput('docs_only', String(docsOnly));

      - name: 仅文档变更 - 回复
        if: ${{ steps.flags.outputs.docs_only == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: '📝 检测到本次提交仅为纯文档/文本变更。已进入文档类审核流程，等待作者最终审核。'
            });



      - name: 设置 Node 版本
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 安装依赖（server）
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd server
          npm ci

      - name: TypeScript 语法检查（server）
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd server
          npx tsc --noEmit

      - name: 安装依赖（client）
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd client
          npm ci

      - name: TypeScript 语法检查（client）
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd client
          npx tsc --noEmit

      - name: 类型检查失败时回复 PR
        if: ${{ failure() }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: '❌ 自动化类型检查未通过。命令：`npx tsc --noEmit`。\n请根据日志修复类型错误后再次提交，系统会重新审查～\n\n参考：仓库内 `./.github/workflows/(49 封私信 _ 99+ 条消息) 使用 Github Action 来做自动化 - 知乎.html`'
            });

      - name: 确保 base 仓库存在 feature 分支
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.issue;
            async function ensureFeature() {
              try {
                await github.rest.git.getRef({ owner, repo, ref: 'heads/feature' });
              } catch (err) {
                if (err.status === 404) {
                  const baseRef = await github.rest.git.getRef({ owner, repo, ref: 'heads/main' });
                  await github.rest.git.createRef({ owner, repo, ref: 'refs/heads/feature', sha: baseRef.data.object.sha });
                } else {
                  throw err;
                }
              }
            }
            await ensureFeature();

      - name: 如目标为 main，则将 PR 目标分支切换为 feature
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' && github.event.pull_request.base.ref == 'main' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.pulls.update({ owner, repo, pull_number: number, base: 'feature' });

      - name: 合并 PR（目标为 feature 时直接合并）
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            try {
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: number });
              if (pr.data.state !== 'open') {
                return await github.rest.issues.createComment({ owner, repo, issue_number: number, body: '⚠️ PR 当前非 open 状态，自动合并已跳过。' });
              }
              await github.rest.pulls.merge({ owner, repo, pull_number: number, merge_method: 'merge' });
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: '✅ 您的 PR 已通过自动化检查，并已合并至 feature（专属测试）分支。\n维护者将进行最终检查，若无问题会合入 main 并在下个版本发布时包含。感谢贡献！\n\n参考：仓库内 `./.github/workflows/(49 封私信 _ 99+ 条消息) 使用 Github Action 来做自动化 - 知乎.html`'
              });
            } catch (e) {
              const msg = (e && e.message) ? e.message : String(e);
              await github.rest.issues.createComment({ owner, repo, issue_number: number, body: `⚠️ 自动合并失败，请维护者查看：\n\n\`\`\`\n${msg}\n\`\`\`` });
              core.setFailed('Auto merge failed');
            }

