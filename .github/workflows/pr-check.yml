name: PR è‡ªåŠ¨å®¡æŸ¥ä¸åˆ†æµ

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  pr-flow:
    name: PR è‡ªåŠ¨åŒ–æµç¨‹
    runs-on: ubuntu-latest

    steps:
      - name: åˆå§‹è¯„è®º - æ­£åœ¨è¿›è¡Œè‡ªåŠ¨åŒ–å®¡æŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: 'ğŸ‘‹ æœ¬ PR å·²è¿›å…¥è‡ªåŠ¨åŒ–å®¡æŸ¥æµç¨‹ï¼Œæ­£åœ¨è¿›è¡Œå˜æ›´è¯†åˆ«ä¸ç±»å‹æ£€æŸ¥ï¼Œè¯·ç¨å€™ï½'
            });

      - name: æ£€å‡º PR æäº¤ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: è¯†åˆ«æ˜¯å¦ä»…ä¿®æ”¹æ–‡æ¡£
        id: flags
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const files = await github.paginate(github.rest.pulls.listFiles, { owner, repo, pull_number: number, per_page: 100 });
            const isDoc = (f) => {
              const n = f.filename.toLowerCase();
              return n.endsWith('.md') || n.endsWith('.mdx') || n.endsWith('.txt') || n.startsWith('docs/');
            };
            const docsOnly = files.length > 0 && files.every(isDoc);
            core.setOutput('docs_only', String(docsOnly));

      - name: ä»…æ–‡æ¡£å˜æ›´ - å›å¤
        if: ${{ steps.flags.outputs.docs_only == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: 'ğŸ“ æ£€æµ‹åˆ°æœ¬æ¬¡æäº¤ä»…ä¸ºçº¯æ–‡æ¡£/æ–‡æœ¬å˜æ›´ã€‚å·²è¿›å…¥æ–‡æ¡£ç±»å®¡æ ¸æµç¨‹ï¼Œç­‰å¾…ä½œè€…æœ€ç»ˆå®¡æ ¸ã€‚'
            });



      - name: è®¾ç½® Node ç‰ˆæœ¬
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–ï¼ˆserverï¼‰
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd server
          npm ci

      - name: TypeScript è¯­æ³•æ£€æŸ¥ï¼ˆserverï¼‰
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd server
          npx tsc --noEmit

      - name: å®‰è£…ä¾èµ–ï¼ˆclientï¼‰
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd client
          npm ci

      - name: TypeScript è¯­æ³•æ£€æŸ¥ï¼ˆclientï¼‰
        if: ${{ steps.flags.outputs.docs_only != 'true' }}
        run: |
          cd client
          npx tsc --noEmit

      - name: ç±»å‹æ£€æŸ¥å¤±è´¥æ—¶å›å¤ PR
        if: ${{ failure() }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: 'âŒ è‡ªåŠ¨åŒ–ç±»å‹æ£€æŸ¥æœªé€šè¿‡ã€‚å‘½ä»¤ï¼š`npx tsc --noEmit`ã€‚\nè¯·æ ¹æ®æ—¥å¿—ä¿®å¤ç±»å‹é”™è¯¯åå†æ¬¡æäº¤ï¼Œç³»ç»Ÿä¼šé‡æ–°å®¡æŸ¥ï½\n\nå‚è€ƒï¼šä»“åº“å†… `./.github/workflows/(49 å°ç§ä¿¡ _ 99+ æ¡æ¶ˆæ¯) ä½¿ç”¨ Github Action æ¥åšè‡ªåŠ¨åŒ– - çŸ¥ä¹.html`'
            });

      - name: ç¡®ä¿ base ä»“åº“å­˜åœ¨ feature åˆ†æ”¯
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.issue;
            async function ensureFeature() {
              try {
                await github.rest.git.getRef({ owner, repo, ref: 'heads/feature' });
              } catch (err) {
                if (err.status === 404) {
                  const baseRef = await github.rest.git.getRef({ owner, repo, ref: 'heads/main' });
                  await github.rest.git.createRef({ owner, repo, ref: 'refs/heads/feature', sha: baseRef.data.object.sha });
                } else {
                  throw err;
                }
              }
            }
            await ensureFeature();

      - name: å¦‚ç›®æ ‡ä¸º mainï¼Œåˆ™å°† PR ç›®æ ‡åˆ†æ”¯åˆ‡æ¢ä¸º feature
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' && github.event.pull_request.base.ref == 'main' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.pulls.update({ owner, repo, pull_number: number, base: 'feature' });

      - name: åˆå¹¶ PRï¼ˆç›®æ ‡ä¸º feature æ—¶ç›´æ¥åˆå¹¶ï¼‰
        if: ${{ success() && steps.flags.outputs.docs_only != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            try {
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: number });
              if (pr.data.state !== 'open') {
                return await github.rest.issues.createComment({ owner, repo, issue_number: number, body: 'âš ï¸ PR å½“å‰é open çŠ¶æ€ï¼Œè‡ªåŠ¨åˆå¹¶å·²è·³è¿‡ã€‚' });
              }
              await github.rest.pulls.merge({ owner, repo, pull_number: number, merge_method: 'merge' });
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: 'âœ… æ‚¨çš„ PR å·²é€šè¿‡è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼Œå¹¶å·²åˆå¹¶è‡³ featureï¼ˆä¸“å±æµ‹è¯•ï¼‰åˆ†æ”¯ã€‚\nç»´æŠ¤è€…å°†è¿›è¡Œæœ€ç»ˆæ£€æŸ¥ï¼Œè‹¥æ— é—®é¢˜ä¼šåˆå…¥ main å¹¶åœ¨ä¸‹ä¸ªç‰ˆæœ¬å‘å¸ƒæ—¶åŒ…å«ã€‚æ„Ÿè°¢è´¡çŒ®ï¼\n\nå‚è€ƒï¼šä»“åº“å†… `./.github/workflows/(49 å°ç§ä¿¡ _ 99+ æ¡æ¶ˆæ¯) ä½¿ç”¨ Github Action æ¥åšè‡ªåŠ¨åŒ– - çŸ¥ä¹.html`'
              });
            } catch (e) {
              const msg = (e && e.message) ? e.message : String(e);
              await github.rest.issues.createComment({ owner, repo, issue_number: number, body: `âš ï¸ è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œè¯·ç»´æŠ¤è€…æŸ¥çœ‹ï¼š\n\n\`\`\`\n${msg}\n\`\`\`` });
              core.setFailed('Auto merge failed');
            }

