name: PRè‡ªåŠ¨æ£€æŸ¥ä¸åˆå¹¶

# æƒé™é…ç½®
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–PRä¿¡æ¯
        id: pr-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "head_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check-files
        run: |
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          git fetch origin ${{ steps.pr-info.outputs.base_branch }}
          CHANGED_FILES=$(git diff --name-only origin/${{ steps.pr-info.outputs.base_branch }}...HEAD)
          echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
          echo "$CHANGED_FILES"
          
          # æ£€æŸ¥æ˜¯å¦åªæœ‰æ–‡æ¡£æ–‡ä»¶å˜æ›´
          NON_DOC_FILES=$(echo "$CHANGED_FILES" | grep -v -E '\.(md|txt|rst|doc|docx|pdf)$' | grep -v '^docs/' | grep -v '^README' | grep -v '^CHANGELOG' | grep -v '^LICENSE' || true)
          
          if [ -z "$NON_DOC_FILES" ]; then
            echo "only_docs=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°ä»…æœ‰æ–‡æ¡£æ–‡ä»¶å˜æ›´"
          else
            echo "only_docs=false" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°éæ–‡æ¡£æ–‡ä»¶å˜æ›´ï¼š"
            echo "$NON_DOC_FILES"
          fi

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        if: steps.check-files.outputs.only_docs == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        if: steps.check-files.outputs.only_docs == 'false'
        run: |
          npm install
          cd client && npm install
          cd ../server && npm install

      - name: TypeScriptç±»å‹æ£€æŸ¥
        if: steps.check-files.outputs.only_docs == 'false'
        id: type-check
        run: |
          echo "å¼€å§‹TypeScriptç±»å‹æ£€æŸ¥..."
          
          # æ£€æŸ¥serverç«¯
          echo "æ£€æŸ¥serverç«¯TypeScript..."
          cd server
          if npx tsc --noEmit; then
            echo "server_check=success" >> $GITHUB_OUTPUT
            echo "âœ… Serverç«¯TypeScriptæ£€æŸ¥é€šè¿‡"
          else
            echo "server_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ Serverç«¯TypeScriptæ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          cd ..
          
          # æ£€æŸ¥clientç«¯
          echo "æ£€æŸ¥clientç«¯TypeScript..."
          cd client
          if npx tsc --noEmit; then
            echo "client_check=success" >> $GITHUB_OUTPUT
            echo "âœ… Clientç«¯TypeScriptæ£€æŸ¥é€šè¿‡"
          else
            echo "client_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ Clientç«¯TypeScriptæ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          echo "type_check_result=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: å¤„ç†TypeScriptæ£€æŸ¥å¤±è´¥
        if: steps.check-files.outputs.only_docs == 'false' && steps.type-check.outputs.type_check_result != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âŒ TypeScriptç±»å‹æ£€æŸ¥å¤±è´¥
            
            æ‚¨çš„PRåŒ…å«TypeScriptç±»å‹é”™è¯¯ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤ã€‚
            
            ### æ£€æŸ¥ç»“æœï¼š
            - Serverç«¯æ£€æŸ¥ï¼š${{ steps.type-check.outputs.server_check == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
            - Clientç«¯æ£€æŸ¥ï¼š${{ steps.type-check.outputs.client_check == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
            
            è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæœ¬åœ°æ£€æŸ¥ï¼š
            \`\`\`bash
            # æ£€æŸ¥serverç«¯
            cd server && npx tsc --noEmit
            
            # æ£€æŸ¥clientç«¯  
            cd client && npx tsc --noEmit
            \`\`\`
            
            ä¿®å¤æ‰€æœ‰ç±»å‹é”™è¯¯åï¼Œè¯·é‡æ–°æ¨é€ä»£ç ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: å¤„ç†çº¯æ–‡æ¡£å˜æ›´
        if: steps.check-files.outputs.only_docs == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ“ æ–‡æ¡£å˜æ›´æ£€æµ‹

            æ£€æµ‹åˆ°æ‚¨çš„PRä»…åŒ…å«æ–‡æ¡£æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€è¿›è¡Œä»£ç æ£€æŸ¥ã€‚

            æ­¤PRæ­£åœ¨ç­‰å¾…é¡¹ç›®ç»´æŠ¤è€…çš„æœ€ç»ˆå®¡æ ¸ã€‚æ„Ÿè°¢æ‚¨å¯¹æ–‡æ¡£çš„è´¡çŒ®ï¼ ğŸ‰`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: è‡ªåŠ¨åˆå¹¶åˆ°featureåˆ†æ”¯
        if: steps.check-files.outputs.only_docs == 'false' && steps.type-check.outputs.type_check_result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const baseBranch = '${{ steps.pr-info.outputs.base_branch }}';
            const headBranch = '${{ steps.pr-info.outputs.head_branch }}';

            // ç¡®å®šç›®æ ‡åˆ†æ”¯
            let targetBranch = 'feature';
            if (baseBranch === 'feature') {
              targetBranch = 'feature';
            } else if (baseBranch === 'main') {
              targetBranch = 'feature';
            }

            try {
              // æ£€æŸ¥featureåˆ†æ”¯æ˜¯å¦å­˜åœ¨
              try {
                await github.rest.repos.getBranch({
                  owner,
                  repo,
                  branch: 'feature'
                });
              } catch (error) {
                if (error.status === 404) {
                  // å¦‚æœfeatureåˆ†æ”¯ä¸å­˜åœ¨ï¼Œä»mainåˆ†æ”¯åˆ›å»º
                  const mainBranch = await github.rest.repos.getBranch({
                    owner,
                    repo,
                    branch: 'main'
                  });

                  await github.rest.git.createRef({
                    owner,
                    repo,
                    ref: 'refs/heads/feature',
                    sha: mainBranch.data.commit.sha
                  });

                  console.log('âœ… å·²åˆ›å»ºfeatureåˆ†æ”¯');
                }
              }

              // å¦‚æœåŸç›®æ ‡æ˜¯mainåˆ†æ”¯ï¼Œéœ€è¦ä¿®æ”¹PRçš„ç›®æ ‡åˆ†æ”¯ä¸ºfeature
              if (baseBranch === 'main') {
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: prNumber,
                  base: 'feature'
                });
                console.log('âœ… å·²å°†PRç›®æ ‡åˆ†æ”¯ä¿®æ”¹ä¸ºfeature');
              }

              // åˆå¹¶PRåˆ°featureåˆ†æ”¯
              const mergeResult = await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: prNumber,
                commit_title: `è‡ªåŠ¨åˆå¹¶: ${{ steps.pr-info.outputs.pr_title }}`,
                commit_message: `é€šè¿‡è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼Œåˆå¹¶åˆ°${targetBranch}åˆ†æ”¯è¿›è¡Œæµ‹è¯•`,
                merge_method: 'squash'
              });

              if (mergeResult.data.merged) {
                const comment = `## âœ… è‡ªåŠ¨åŒ–æ£€æŸ¥é€šè¿‡

                æ‚¨çš„PRå·²é€šè¿‡æ‰€æœ‰è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼Œå·²æˆåŠŸåˆå¹¶åˆ° \`${targetBranch}\` åˆ†æ”¯è¿›è¡Œæµ‹è¯•ã€‚

                ### æ£€æŸ¥ç»“æœï¼š
                - TypeScriptç±»å‹æ£€æŸ¥ï¼šâœ… é€šè¿‡
                - Serverç«¯æ£€æŸ¥ï¼šâœ… é€šè¿‡
                - Clientç«¯æ£€æŸ¥ï¼šâœ… é€šè¿‡

                æ‚¨çš„ä»£ç ç°åœ¨åœ¨ä¸“å±æµ‹è¯•åˆ†æ”¯ä¸­ï¼Œé¡¹ç›®ç»´æŠ¤è€…å°†è¿›è¡Œæœ€ç»ˆæ£€æŸ¥ã€‚å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œå°†ä¼šåˆå¹¶åˆ°ä¸»åˆ†æ”¯å¹¶åœ¨ä¸‹ä¸ªç‰ˆæœ¬å‘å¸ƒæ—¶åŠ å…¥ã€‚

                æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ ğŸ‰`;

                await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner,
                  repo,
                  body: comment
                });

                console.log('âœ… PRå·²æˆåŠŸåˆå¹¶åˆ°featureåˆ†æ”¯');
              }

            } catch (error) {
              console.error('åˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);

              const errorComment = `## âš ï¸ è‡ªåŠ¨åˆå¹¶å¤±è´¥

              è™½ç„¶ä»£ç æ£€æŸ¥é€šè¿‡ï¼Œä½†è‡ªåŠ¨åˆå¹¶è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ã€‚å¯èƒ½çš„åŸå› ï¼š
              - å­˜åœ¨åˆå¹¶å†²çª
              - åˆ†æ”¯ä¿æŠ¤è§„åˆ™é™åˆ¶
              - æƒé™ä¸è¶³

              è¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…æ‰‹åŠ¨å¤„ç†æ­¤PRã€‚

              é”™è¯¯ä¿¡æ¯ï¼š\`${error.message}\``;

              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner,
                repo,
                body: errorComment
              });
            }
