name: PRè‡ªåŠ¨æ£€æŸ¥å’Œåˆå¹¶

# æƒé™é…ç½®
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  checks: write
  statuses: write

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - develop
      - 'feature/**'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PRç¼–å·ï¼ˆç”¨äºæ‰‹åŠ¨è°ƒè¯•ï¼‰'
        required: true
        type: string

jobs:
  check-pr:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'npm'

      - name: åˆå§‹å›å¤PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { owner, repo } = context.repo;
              const pull_number = context.payload.pull_request.number;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `## ğŸ”„ è‡ªåŠ¨åŒ–å®¡æŸ¥å¼€å§‹

                æ‚¨çš„PRæˆ‘ä»¬å·²ç»æ”¶åˆ°ï¼Œæ­£åœ¨è¿è¡Œè‡ªåŠ¨åŒ–å®¡æŸ¥ï¼Œç¨åæ‚¨å°†ä¼šæ”¶åˆ°å…·ä½“å®¡æ ¸æŠ¥å‘Šï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚

                ---
                *æ­¤æ¶ˆæ¯ç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿå‘é€*`
              });
            } catch (error) {
              console.log('æ— æ³•åˆ›å»ºè¯„è®ºï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜:', error.message);
              console.log('ç»§ç»­æ‰§è¡Œå…¶ä»–æ£€æŸ¥æ­¥éª¤...');
            }

      - name: æ£€æŸ¥PRç›®æ ‡åˆ†æ”¯å’Œæ–‡ä»¶å˜æ›´ç±»å‹
        id: check-files
        run: |
          # æ£€æŸ¥æ˜¯å¦ä¸ºæ‰‹åŠ¨è¿è¡Œ
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "è¿™æ˜¯æ‰‹åŠ¨è¿è¡Œï¼Œè·³è¿‡PRæ£€æŸ¥ï¼Œç›´æ¥è¿›è¡Œè¯­æ³•æ£€æŸ¥"
            echo "target_branch=manual" >> $GITHUB_OUTPUT
            echo "is_main_branch=false" >> $GITHUB_OUTPUT
            echo "doc_only=false" >> $GITHUB_OUTPUT
            echo "has_code_files=true" >> $GITHUB_OUTPUT
            echo "æ‰‹åŠ¨è¿è¡Œæ¨¡å¼ï¼Œå°†æ£€æŸ¥æ‰€æœ‰TypeScriptæ–‡ä»¶"
            exit 0
          fi

          # è·å–PRç›®æ ‡åˆ†æ”¯
          TARGET_BRANCH="${{ github.base_ref }}"
          echo "PRç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT

          # åˆ¤æ–­æ˜¯å¦ä¸ºä¸»åˆ†æ”¯
          if [[ "$TARGET_BRANCH" == "main" || "$TARGET_BRANCH" == "master" || "$TARGET_BRANCH" == "develop" ]]; then
            echo "is_main_branch=true" >> $GITHUB_OUTPUT
            echo "è¿™æ˜¯å‘ä¸»åˆ†æ”¯æäº¤çš„PR"
          else
            echo "is_main_branch=false" >> $GITHUB_OUTPUT
            echo "è¿™æ˜¯å‘éä¸»åˆ†æ”¯æäº¤çš„PR"
          fi

          # è·å–PRä¸­å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          # æ£€æŸ¥æ˜¯å¦åªåŒ…å«æ–‡æ¡£æ–‡ä»¶
          doc_only=true
          has_code_files=false

          while IFS= read -r file; do
            echo "æ£€æŸ¥æ–‡ä»¶: $file"
            # æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡æ¡£æ–‡ä»¶ï¼ˆ.md, .txt, .rst, .doc, .docx, .pdfç­‰ï¼‰
            if [[ ! "$file" =~ \.(md|txt|rst|doc|docx|pdf|LICENSE|README)$ ]] && [[ ! "$file" =~ ^docs/ ]] && [[ ! "$file" =~ ^\.github/ ]]; then
              doc_only=false
              has_code_files=true
              echo "å‘ç°ä»£ç æ–‡ä»¶: $file"
            fi
          done < changed_files.txt

          echo "doc_only=$doc_only" >> $GITHUB_OUTPUT
          echo "has_code_files=$has_code_files" >> $GITHUB_OUTPUT

          # è¾“å‡ºå˜æ›´æ–‡ä»¶åˆ—è¡¨ç”¨äºè°ƒè¯•
          echo "å˜æ›´çš„æ–‡ä»¶:"
          cat changed_files.txt

      - name: å®‰è£…ä¾èµ–ï¼ˆä»…å½“æœ‰ä»£ç æ–‡ä»¶æ—¶æˆ–æ‰‹åŠ¨è¿è¡Œï¼‰
        if: steps.check-files.outputs.has_code_files == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "å®‰è£…æ ¹ç›®å½•ä¾èµ–..."
          npm install
          
          echo "å®‰è£…å®¢æˆ·ç«¯ä¾èµ–..."
          cd client && npm install
          cd ..
          
          echo "å®‰è£…æœåŠ¡ç«¯ä¾èµ–..."
          cd server && npm install
          cd ..

      - name: TypeScriptè¯­æ³•æ£€æŸ¥ - å®¢æˆ·ç«¯
        if: steps.check-files.outputs.has_code_files == 'true' || github.event_name == 'workflow_dispatch'
        id: tsc-check-client
        run: |
          echo "æ£€æŸ¥å®¢æˆ·ç«¯TypeScriptè¯­æ³•..."
          cd client
          if npx tsc --noEmit; then
            echo "client_check=success" >> $GITHUB_OUTPUT
            echo "âœ… å®¢æˆ·ç«¯TypeScriptè¯­æ³•æ£€æŸ¥é€šè¿‡"
          else
            echo "client_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ å®¢æˆ·ç«¯TypeScriptè¯­æ³•æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

      - name: TypeScriptè¯­æ³•æ£€æŸ¥ - æœåŠ¡ç«¯
        if: steps.check-files.outputs.has_code_files == 'true' || github.event_name == 'workflow_dispatch'
        id: tsc-check-server
        run: |
          echo "æ£€æŸ¥æœåŠ¡ç«¯TypeScriptè¯­æ³•..."
          cd server
          if npx tsc --noEmit; then
            echo "server_check=success" >> $GITHUB_OUTPUT
            echo "âœ… æœåŠ¡ç«¯TypeScriptè¯­æ³•æ£€æŸ¥é€šè¿‡"
          else
            echo "server_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ æœåŠ¡ç«¯TypeScriptè¯­æ³•æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

      - name: å›å¤PR - è¯­æ³•æ£€æŸ¥å¤±è´¥
        if: failure() && steps.check-files.outputs.has_code_files == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { owner, repo } = context.repo;
              const pull_number = context.payload.pull_request.number;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `## âŒ è‡ªåŠ¨æ£€æŸ¥å¤±è´¥

                æ‚¨çš„PRåŒ…å«TypeScriptè¯­æ³•é”™è¯¯ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤ã€‚

                ### æ£€æŸ¥ç»“æœï¼š
                - å®¢æˆ·ç«¯æ£€æŸ¥: ${{ steps.tsc-check-client.outputs.client_check || 'æœªæ‰§è¡Œ' }}
                - æœåŠ¡ç«¯æ£€æŸ¥: ${{ steps.tsc-check-server.outputs.server_check || 'æœªæ‰§è¡Œ' }}

                è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤åœ¨æœ¬åœ°æ£€æŸ¥è¯­æ³•é”™è¯¯ï¼š
                \`\`\`bash
                # æ£€æŸ¥å®¢æˆ·ç«¯
                cd client && npx tsc --noEmit

                # æ£€æŸ¥æœåŠ¡ç«¯
                cd server && npx tsc --noEmit
                \`\`\`

                ä¿®å¤æ‰€æœ‰é”™è¯¯åï¼Œè¯·é‡æ–°æ¨é€ä»£ç ã€‚`
              });
            } catch (error) {
              console.log('æ— æ³•åˆ›å»ºè¯„è®º:', error.message);
              // è®¾ç½®å·¥ä½œæµçŠ¶æ€ä¸ºå¤±è´¥ï¼Œå³ä½¿è¯„è®ºå¤±è´¥
              core.setFailed('TypeScriptè¯­æ³•æ£€æŸ¥å¤±è´¥');
            }

      - name: å›å¤PR - çº¯æ–‡æ¡£å˜æ›´
        if: steps.check-files.outputs.doc_only == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: `## ğŸ“ æ–‡æ¡£å˜æ›´æ£€æµ‹
              
              æ­¤PRå°†ç­‰å¾…é¡¹ç›®ç»´æŠ¤è€…è¿›è¡Œæœ€ç»ˆå®¡æ ¸ã€‚æ„Ÿè°¢æ‚¨å¯¹æ–‡æ¡£çš„è´¡çŒ®ï¼ ğŸ‰`
            });

      - name: åˆ›å»ºæˆ–åˆ‡æ¢åˆ°featureåˆ†æ”¯ï¼ˆä»…ä¸»åˆ†æ”¯PRï¼‰
        if: success() && steps.check-files.outputs.has_code_files == 'true' && steps.check-files.outputs.is_main_branch == 'true'
        run: |
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # åˆ›å»ºfeatureåˆ†æ”¯åç§°ï¼ˆåŸºäºPRç¼–å·ï¼‰
          FEATURE_BRANCH="feature/pr-${{ github.event.number }}"
          echo "FEATURE_BRANCH=$FEATURE_BRANCH" >> $GITHUB_ENV
          echo "å‡†å¤‡åˆ›å»ºfeatureåˆ†æ”¯: $FEATURE_BRANCH"

          # æ£€æŸ¥featureåˆ†æ”¯æ˜¯å¦å·²å­˜åœ¨
          if git ls-remote --heads origin $FEATURE_BRANCH | grep -q $FEATURE_BRANCH; then
            echo "Featureåˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯¥åˆ†æ”¯"
            git fetch origin $FEATURE_BRANCH
            git checkout $FEATURE_BRANCH
            git merge origin/${{ github.head_ref }} --no-ff -m "Merge latest changes from PR #${{ github.event.number }}"
          else
            echo "åˆ›å»ºæ–°çš„featureåˆ†æ”¯"
            git checkout -b $FEATURE_BRANCH
          fi

      - name: æ¨é€åˆ°featureåˆ†æ”¯ï¼ˆä»…ä¸»åˆ†æ”¯PRï¼‰
        if: success() && steps.check-files.outputs.has_code_files == 'true' && steps.check-files.outputs.is_main_branch == 'true'
        run: |
          echo "å°è¯•æ¨é€åˆ°featureåˆ†æ”¯..."
          if git push origin $FEATURE_BRANCH; then
            echo "âœ… æˆåŠŸæ¨é€åˆ°featureåˆ†æ”¯"
            echo "push_success=true" >> $GITHUB_ENV
          else
            echo "âŒ æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜"
            echo "push_success=false" >> $GITHUB_ENV
            echo "è¯·æ‰‹åŠ¨åˆ›å»ºfeatureåˆ†æ”¯: $FEATURE_BRANCH"
          fi

      - name: è¾“å‡ºæ£€æŸ¥ç»“æœï¼ˆä¸»åˆ†æ”¯PRï¼‰
        if: always() && steps.check-files.outputs.has_code_files == 'true' && steps.check-files.outputs.is_main_branch == 'true'
        run: |
          echo "=== TypeScriptæ£€æŸ¥ç»“æœ ==="
          echo "å®¢æˆ·ç«¯æ£€æŸ¥: ${{ steps.tsc-check-client.outputs.client_check || 'æœªæ‰§è¡Œ' }}"
          echo "æœåŠ¡ç«¯æ£€æŸ¥: ${{ steps.tsc-check-server.outputs.server_check || 'æœªæ‰§è¡Œ' }}"
          echo "Featureåˆ†æ”¯: ${{ env.FEATURE_BRANCH || 'æœªåˆ›å»º' }}"
          echo "æ¨é€çŠ¶æ€: ${{ env.push_success || 'æœªæ¨é€' }}"

          if [[ "${{ steps.tsc-check-client.outputs.client_check }}" == "success" && "${{ steps.tsc-check-server.outputs.server_check }}" == "success" ]]; then
            echo "âœ… TypeScriptè¯­æ³•æ£€æŸ¥é€šè¿‡"
            if [[ "${{ env.push_success }}" == "true" ]]; then
              echo "âœ… ä»£ç å·²æˆåŠŸåˆå¹¶åˆ°featureåˆ†æ”¯"
            else
              echo "âš ï¸  ç”±äºæƒé™é™åˆ¶ï¼Œæ— æ³•è‡ªåŠ¨åˆ›å»ºfeatureåˆ†æ”¯"
              echo "è¯·ç»´æŠ¤è€…æ‰‹åŠ¨åˆ›å»ºåˆ†æ”¯: ${{ env.FEATURE_BRANCH }}"
            fi
          else
            echo "âŒ TypeScriptè¯­æ³•æ£€æŸ¥å¤±è´¥"
          fi

      - name: å›å¤PR - æ£€æŸ¥é€šè¿‡ï¼ˆä¸»åˆ†æ”¯PRï¼‰
        if: always() && steps.check-files.outputs.has_code_files == 'true' && steps.check-files.outputs.is_main_branch == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { owner, repo, number } = context.issue;
              const featureBranch = process.env.FEATURE_BRANCH || 'feature/pr-' + number;
              const pushSuccess = process.env.push_success === 'true';
              const clientCheck = '${{ steps.tsc-check-client.outputs.client_check }}';
              const serverCheck = '${{ steps.tsc-check-server.outputs.server_check }}';

              let statusIcon = 'âœ…';
              let statusText = 'è‡ªåŠ¨åŒ–æ£€æŸ¥é€šè¿‡';
              let branchInfo = '';

              if (clientCheck !== 'success' || serverCheck !== 'success') {
                statusIcon = 'âŒ';
                statusText = 'è‡ªåŠ¨åŒ–æ£€æŸ¥å¤±è´¥';
              }

              if (pushSuccess) {
                branchInfo = `ä»£ç å·²åˆå¹¶åˆ°ä¸“å±æµ‹è¯•åˆ†æ”¯ \`${featureBranch}\`ã€‚`;
              } else {
                branchInfo = `ç”±äºæƒé™é™åˆ¶ï¼Œæ— æ³•è‡ªåŠ¨åˆ›å»ºfeatureåˆ†æ”¯ã€‚è¯·ç»´æŠ¤è€…æ‰‹åŠ¨åˆ›å»ºåˆ†æ”¯ \`${featureBranch}\`ã€‚`;
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body: `## ${statusIcon} ${statusText}

                ${branchInfo}

                ### æ£€æŸ¥ç»“æœï¼š
                - ${clientCheck === 'success' ? 'âœ…' : 'âŒ'} å®¢æˆ·ç«¯TypeScriptè¯­æ³•æ£€æŸ¥${clientCheck === 'success' ? 'é€šè¿‡' : 'å¤±è´¥'}
                - ${serverCheck === 'success' ? 'âœ…' : 'âŒ'} æœåŠ¡ç«¯TypeScriptè¯­æ³•æ£€æŸ¥${serverCheck === 'success' ? 'é€šè¿‡' : 'å¤±è´¥'}
                - ${pushSuccess ? 'âœ… ä»£ç å·²åˆå¹¶åˆ°æµ‹è¯•åˆ†æ”¯' : 'âš ï¸ éœ€è¦æ‰‹åŠ¨åˆ›å»ºæµ‹è¯•åˆ†æ”¯'}

                ${clientCheck === 'success' && serverCheck === 'success' ?
                  'æ¥ä¸‹æ¥å°†ç­‰å¾…é¡¹ç›®ç»´æŠ¤è€…è¿›è¡Œæœ€ç»ˆæ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰é—®é¢˜å°†ä¼šåˆå¹¶åˆ°ä¸»åˆ†æ”¯å¹¶åœ¨ä¸‹ä¸ªç‰ˆæœ¬å‘å¸ƒæ—¶åŠ å…¥ã€‚\n\næ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ ğŸ‰' :
                  'è¯·ä¿®å¤è¯­æ³•é”™è¯¯åé‡æ–°æäº¤ã€‚'}
                `
              });
            } catch (error) {
              console.log('æ— æ³•åˆ›å»ºè¯„è®º:', error.message);
            }

      - name: å›å¤PR - æ£€æŸ¥é€šè¿‡ï¼ˆfeatureåˆ†æ”¯PRï¼‰
        if: success() && steps.check-files.outputs.has_code_files == 'true' && steps.check-files.outputs.is_main_branch == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo, number } = context.issue;
            const targetBranch = '${{ steps.check-files.outputs.target_branch }}';
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: `## âœ… è‡ªåŠ¨åŒ–æ£€æŸ¥é€šè¿‡

              æ‚¨çš„PRå·²é€šè¿‡è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼Œç›®æ ‡åˆ†æ”¯ä¸º \`${targetBranch}\`ã€‚

              ### æ£€æŸ¥ç»“æœï¼š
              - âœ… å®¢æˆ·ç«¯TypeScriptè¯­æ³•æ£€æŸ¥é€šè¿‡
              - âœ… æœåŠ¡ç«¯TypeScriptè¯­æ³•æ£€æŸ¥é€šè¿‡
              - âœ… ä»£ç è¯­æ³•éªŒè¯å®Œæˆ

              ç”±äºæ‚¨çš„PRç›®æ ‡æ˜¯featureåˆ†æ”¯ï¼Œå°†ç­‰å¾…é¡¹ç›®ç»´æŠ¤è€…è¿›è¡Œå®¡æ ¸å’Œåˆå¹¶ã€‚

              æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ ğŸ‰`
            });

      - name: æ‰‹åŠ¨è¿è¡Œç»“æœè¾“å‡º
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== æ‰‹åŠ¨è¿è¡ŒTypeScriptæ£€æŸ¥å®Œæˆ ==="
          echo "å®¢æˆ·ç«¯æ£€æŸ¥ç»“æœ: ${{ steps.tsc-check-client.outputs.client_check || 'æœªæ‰§è¡Œ' }}"
          echo "æœåŠ¡ç«¯æ£€æŸ¥ç»“æœ: ${{ steps.tsc-check-server.outputs.server_check || 'æœªæ‰§è¡Œ' }}"

          if [[ "${{ steps.tsc-check-client.outputs.client_check }}" == "success" && "${{ steps.tsc-check-server.outputs.server_check }}" == "success" ]]; then
            echo "âœ… æ‰€æœ‰TypeScriptè¯­æ³•æ£€æŸ¥é€šè¿‡ï¼"
          else
            echo "âŒ å­˜åœ¨TypeScriptè¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„è¾“å‡º"
            exit 1
          fi
