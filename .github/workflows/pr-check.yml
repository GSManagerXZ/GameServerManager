name: PRè‡ªåŠ¨æ£€æŸ¥ä¸åˆå¹¶

# æƒé™é…ç½® - éœ€è¦æ›´å¤šæƒé™æ¥æ‰§è¡Œåˆå¹¶æ“ä½œ
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  checks: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    runs-on: ubuntu-latest
    steps:
      - name: è°ƒè¯•æƒé™å’Œç¯å¢ƒä¿¡æ¯
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:');
            console.log('Repository:', context.repo);
            console.log('Event:', context.eventName);
            console.log('Actor:', context.actor);
            console.log('PR Number:', context.issue.number);

            // æ£€æŸ¥æƒé™
            try {
              const repo = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              console.log('âœ… ä»“åº“è®¿é—®æƒé™æ­£å¸¸');
              console.log('ä»“åº“æƒé™:', repo.data.permissions);
            } catch (error) {
              console.log('âŒ ä»“åº“è®¿é—®æƒé™æ£€æŸ¥å¤±è´¥:', error.message);
            }

            // æµ‹è¯•è¯„è®ºæƒé™
            try {
              const testComment = await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'ğŸ¤– æƒé™æµ‹è¯•ï¼šGitHub Actions å¯ä»¥æ­£å¸¸åˆ›å»ºè¯„è®º'
              });
              console.log('âœ… è¯„è®ºæƒé™æ­£å¸¸');
            } catch (error) {
              console.log('âŒ è¯„è®ºæƒé™æ£€æŸ¥å¤±è´¥:', error.message);
              console.log('é”™è¯¯è¯¦æƒ…:', error);
            }

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–PRä¿¡æ¯
        id: pr-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "head_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check-files
        run: |
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          git fetch origin ${{ steps.pr-info.outputs.base_branch }}
          CHANGED_FILES=$(git diff --name-only origin/${{ steps.pr-info.outputs.base_branch }}...HEAD)
          echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
          echo "$CHANGED_FILES"
          
          # æ£€æŸ¥æ˜¯å¦åªæœ‰æ–‡æ¡£æ–‡ä»¶å˜æ›´
          NON_DOC_FILES=$(echo "$CHANGED_FILES" | grep -v -E '\.(md|txt|rst|doc|docx|pdf)$' | grep -v '^docs/' | grep -v '^README' | grep -v '^CHANGELOG' | grep -v '^LICENSE' || true)
          
          if [ -z "$NON_DOC_FILES" ]; then
            echo "only_docs=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°ä»…æœ‰æ–‡æ¡£æ–‡ä»¶å˜æ›´"
          else
            echo "only_docs=false" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°éæ–‡æ¡£æ–‡ä»¶å˜æ›´ï¼š"
            echo "$NON_DOC_FILES"
          fi

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        if: steps.check-files.outputs.only_docs == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        if: steps.check-files.outputs.only_docs == 'false'
        run: |
          npm install
          cd client && npm install
          cd ../server && npm install

      - name: TypeScriptç±»å‹æ£€æŸ¥
        if: steps.check-files.outputs.only_docs == 'false'
        id: type-check
        run: |
          echo "å¼€å§‹TypeScriptç±»å‹æ£€æŸ¥..."
          
          # æ£€æŸ¥serverç«¯
          echo "æ£€æŸ¥serverç«¯TypeScript..."
          cd server
          if npx tsc --noEmit; then
            echo "server_check=success" >> $GITHUB_OUTPUT
            echo "âœ… Serverç«¯TypeScriptæ£€æŸ¥é€šè¿‡"
          else
            echo "server_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ Serverç«¯TypeScriptæ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          cd ..
          
          # æ£€æŸ¥clientç«¯
          echo "æ£€æŸ¥clientç«¯TypeScript..."
          cd client
          if npx tsc --noEmit; then
            echo "client_check=success" >> $GITHUB_OUTPUT
            echo "âœ… Clientç«¯TypeScriptæ£€æŸ¥é€šè¿‡"
          else
            echo "client_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ Clientç«¯TypeScriptæ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          echo "type_check_result=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: å¤„ç†TypeScriptæ£€æŸ¥å¤±è´¥
        if: steps.check-files.outputs.only_docs == 'false' && steps.type-check.outputs.type_check_result != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âŒ TypeScriptç±»å‹æ£€æŸ¥å¤±è´¥

            æ‚¨çš„PRåŒ…å«TypeScriptç±»å‹é”™è¯¯ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤ã€‚

            ### æ£€æŸ¥ç»“æœï¼š
            - Serverç«¯æ£€æŸ¥ï¼š${{ steps.type-check.outputs.server_check == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
            - Clientç«¯æ£€æŸ¥ï¼š${{ steps.type-check.outputs.client_check == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}

            ### æœ¬åœ°æ£€æŸ¥å‘½ä»¤ï¼š
            \`\`\`bash
            # å®‰è£…ä¾èµ–
            npm run install:all

            # è¿è¡Œå®Œæ•´æ£€æŸ¥
            npm run check-types

            # æˆ–è€…åˆ†åˆ«æ£€æŸ¥
            cd server && npx tsc --noEmit
            cd client && npx tsc --noEmit
            \`\`\`

            ### å¸¸è§é—®é¢˜ï¼š
            - æ£€æŸ¥ç±»å‹å®šä¹‰æ˜¯å¦æ­£ç¡®
            - ç¡®ä¿æ‰€æœ‰å¯¼å…¥è·¯å¾„æ­£ç¡®
            - ç§»é™¤æœªä½¿ç”¨çš„å˜é‡å’Œå¯¼å…¥

            ä¿®å¤æ‰€æœ‰ç±»å‹é”™è¯¯åï¼Œè¯·é‡æ–°æ¨é€ä»£ç ã€‚`;

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('âœ… å·²åˆ›å»ºé”™è¯¯æç¤ºè¯„è®º');
            } catch (error) {
              console.log('âŒ åˆ›å»ºè¯„è®ºå¤±è´¥ï¼Œä½†æ£€æŸ¥ç»“æœå·²è®°å½•:', error.message);
            }

      - name: å¤„ç†çº¯æ–‡æ¡£å˜æ›´
        if: steps.check-files.outputs.only_docs == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ“ æ–‡æ¡£å˜æ›´æ£€æµ‹

            æ£€æµ‹åˆ°æ‚¨çš„PRä»…åŒ…å«æ–‡æ¡£æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€è¿›è¡Œä»£ç æ£€æŸ¥ã€‚

            æ­¤PRæ­£åœ¨ç­‰å¾…é¡¹ç›®ç»´æŠ¤è€…çš„æœ€ç»ˆå®¡æ ¸ã€‚æ„Ÿè°¢æ‚¨å¯¹æ–‡æ¡£çš„è´¡çŒ®ï¼ ğŸ‰

            ### å˜æ›´ç±»å‹ï¼š
            - ğŸ“„ æ–‡æ¡£æ–‡ä»¶æ›´æ–°
            - âœ… è·³è¿‡ä»£ç æ£€æŸ¥
            - â³ ç­‰å¾…äººå·¥å®¡æ ¸`;

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('âœ… å·²åˆ›å»ºæ–‡æ¡£å˜æ›´æç¤ºè¯„è®º');
            } catch (error) {
              console.log('âŒ åˆ›å»ºè¯„è®ºå¤±è´¥ï¼Œä½†æ–‡æ¡£å˜æ›´å·²æ£€æµ‹:', error.message);
            }

      - name: æ£€æŸ¥åˆå¹¶æƒé™
        if: steps.check-files.outputs.only_docs == 'false' && steps.type-check.outputs.type_check_result == 'success'
        id: check-permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;

            try {
              // æ£€æŸ¥PRè¯¦æƒ…
              const pr = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });

              console.log('PRçŠ¶æ€:', pr.data.state);
              console.log('å¯åˆå¹¶çŠ¶æ€:', pr.data.mergeable);
              console.log('åˆå¹¶çŠ¶æ€æ£€æŸ¥:', pr.data.mergeable_state);

              // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆå¹¶
              if (pr.data.state !== 'open') {
                console.log('âŒ PRä¸æ˜¯å¼€æ”¾çŠ¶æ€');
                return { canMerge: false, reason: 'PRä¸æ˜¯å¼€æ”¾çŠ¶æ€' };
              }

              if (pr.data.mergeable === false) {
                console.log('âŒ PRå­˜åœ¨åˆå¹¶å†²çª');
                return { canMerge: false, reason: 'å­˜åœ¨åˆå¹¶å†²çª' };
              }

              console.log('âœ… PRå¯ä»¥åˆå¹¶');
              return { canMerge: true, pr: pr.data };

            } catch (error) {
              console.log('âŒ æƒé™æ£€æŸ¥å¤±è´¥:', error.message);
              return { canMerge: false, reason: error.message };
            }

      - name: åˆ›å»ºæˆåŠŸè¯„è®ºï¼ˆæ— è‡ªåŠ¨åˆå¹¶ï¼‰
        if: steps.check-files.outputs.only_docs == 'false' && steps.type-check.outputs.type_check_result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const baseBranch = '${{ steps.pr-info.outputs.base_branch }}';

            // ç¡®å®šç›®æ ‡åˆ†æ”¯é€»è¾‘
            let targetBranch = 'feature';
            let branchMessage = '';

            if (baseBranch === 'main') {
              branchMessage = '\nâš ï¸ **æ³¨æ„**: æ‚¨çš„PRç›®æ ‡æ˜¯mainåˆ†æ”¯ï¼Œå»ºè®®é¡¹ç›®ç»´æŠ¤è€…å°†å…¶åˆå¹¶åˆ°featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•ã€‚';
            } else if (baseBranch === 'feature') {
              branchMessage = '\nâœ… **ç›®æ ‡åˆ†æ”¯**: æ‚¨çš„PRæ­£ç¡®åœ°æŒ‡å‘äº†featureåˆ†æ”¯ã€‚';
            }

            const comment = `## âœ… è‡ªåŠ¨åŒ–æ£€æŸ¥é€šè¿‡

            æ‚¨çš„PRå·²é€šè¿‡æ‰€æœ‰è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼

            ### æ£€æŸ¥ç»“æœï¼š
            - TypeScriptç±»å‹æ£€æŸ¥ï¼šâœ… é€šè¿‡
            - Serverç«¯æ£€æŸ¥ï¼šâœ… é€šè¿‡
            - Clientç«¯æ£€æŸ¥ï¼šâœ… é€šè¿‡
            ${branchMessage}

            ### ä¸‹ä¸€æ­¥ï¼š
            é¡¹ç›®ç»´æŠ¤è€…å°†å®¡æ ¸æ‚¨çš„ä»£ç å¹¶å†³å®šåˆå¹¶ç­–ç•¥ï¼š
            - å¦‚æœç›®æ ‡æ˜¯mainåˆ†æ”¯ï¼Œå°†å…ˆåˆå¹¶åˆ°featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•
            - æµ‹è¯•é€šè¿‡åä¼šåˆå¹¶åˆ°ä¸»åˆ†æ”¯å¹¶åœ¨ä¸‹ä¸ªç‰ˆæœ¬å‘å¸ƒæ—¶åŠ å…¥

            æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ ğŸ‰

            ---
            *æ³¨ï¼šç”±äºGitHubæƒé™é™åˆ¶ï¼Œæš‚æ—¶æ— æ³•è‡ªåŠ¨åˆå¹¶ï¼Œéœ€è¦ç»´æŠ¤è€…æ‰‹åŠ¨æ“ä½œã€‚*`;

            try {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner,
                repo,
                body: comment
              });
              console.log('âœ… æˆåŠŸåˆ›å»ºè¯„è®º');
            } catch (error) {
              console.log('âŒ åˆ›å»ºè¯„è®ºå¤±è´¥:', error.message);
              // å¦‚æœè¯„è®ºå¤±è´¥ï¼Œè‡³å°‘åœ¨æ—¥å¿—ä¸­è®°å½•æˆåŠŸä¿¡æ¯
              console.log('ğŸ‰ TypeScriptæ£€æŸ¥é€šè¿‡ï¼Œä½†æ— æ³•åˆ›å»ºè¯„è®º');
            }
